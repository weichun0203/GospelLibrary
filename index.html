<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart App Link</title>
  <meta name="description" content="Auto-detect iOS/Android and open the right app link with graceful fallback." />
  <style>
    :root { --fg:#0f172a; --muted:#475569; --bg:#f8fafc; --card:#ffffff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; color:var(--fg); background:linear-gradient(180deg, var(--bg), #eef2ff); }
    .wrap { min-height:100dvh; display:grid; place-items:center; padding:24px; }
    .card { width:min(780px, 100%); background:var(--card); border-radius:20px; padding:28px; box-shadow:0 10px 30px rgba(2,6,23,.08); }
    h1 { font-size:clamp(22px, 3vw, 28px); margin:0 0 8px; }
    p { color:var(--muted); margin:0 0 16px; line-height:1.7; }
    .btns { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
    a.btn { text-decoration:none; display:inline-block; padding:12px 16px; border-radius:12px; border:1px solid #e2e8f0; background:#fff; }
    a.btn:hover { border-color:#cbd5e1; }
    code { background:#f1f5f9; padding:.2em .4em; border-radius:6px; }
    .small { font-size:12px; color:#64748b; }
    .warn { background:#fff7ed; border:1px solid #fed7aa; padding:10px 12px; border-radius:12px; color:#9a3412; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>正在為你開啟 App…</h1>
      <p>若數秒內沒有自動跳轉，請手動點擊下方按鈕。</p>
      <div class="btns">
        <a id="openApp" class="btn" href="#">立即開啟 App</a>
        <a id="iosStore" class="btn" href="#">到 iOS App Store</a>
        <a id="androidStore" class="btn" href="#">到 Google Play</a>
        <a id="webFallback" class="btn" href="#">改用網頁版本</a>
      </div>
      <p class="small">此頁會依據你的裝置自動開啟 App（若未安裝則帶你到商店）。</p>
      <p class="small">開發者：請務必把 <code>APP_SCHEME</code> 改成目標 App 真實的自訂 URL Scheme 或 Universal Link，否則無法直接開啟 App。</p>
      <p id="inAppHint" class="small warn" style="display:none;">偵測到你使用的是 LINE/IG/FB 內建瀏覽器，可能會擋下開啟外部 App。請點右上角「⋯」→ 選擇「在瀏覽器開啟」，或直接點下方商店按鈕。</p>
    </div>
  </div>

  <script>
    // === CONFIG: 依專案調整 ===
    const CONFIG = {
      // 1) 商店頁面（若未安裝 App 的 fallback）
      IOS_APP_STORE_URL: "https://apps.apple.com/tw/app/%E7%A6%8F%E9%9F%B3%E5%9C%96%E6%9B%B8%E9%A4%A8/id598329798", // iOS 建議用 itms-apps 直接開啟 App Store
      ANDROID_PLAY_URL: "https://play.google.com/store/apps/details?id=org.lds.ldssa&hl=zh_TW&pli=1",             // Android 建議用 market:// 直接開啟 Play App
      ANDROID_PLAY_WEB_URL: "https://play.google.com/store/apps/details?id=org.lds.ldssa&hl=zh_TW&pli=1", // 網頁版備援

      // 2) 深連結（『已安裝 App』時直達 App）
      // ※ 這個一定要換成『對方 App 真正支援的』 scheme 或 Universal Link，否則不會成功。
      // 例："gospellibrary://open" 或某個 https:// 的通用連結（若 App 有設定 App Links/Universal Links）
      APP_SCHEME: "", // ← TODO: 改成真正的！

      // 3) 網頁版後備（桌面瀏覽器或無法開啟時）
      WEB_FALLBACK_URL: "https://example.com/landing",

      // 4) 啟動逾時（毫秒）：嘗試開 App 失敗後，改導至商店
      OPEN_TIMEOUT_MS: 1500,
    };

    // === UA 裝置與內建瀏覽器偵測 ===
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isAndroid = /Android/i.test(ua);
    const isIOSClassic = /iPhone|iPad|iPod/i.test(ua);
    const isIpadOS13Plus = (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isIOS = isIOSClassic || isIpadOS13Plus;
    const isLINE = /Line\//i.test(ua) || /Line/i.test(ua);
    const isFB = /FBAN|FBAV|FB_IAB/i.test(ua);
    const isIG = /Instagram/i.test(ua);

    if (isLINE || isFB || isIG) {
      document.getElementById('inAppHint').style.display = 'block';
    }

    // 保留目前網址參數與片段，轉交給 app 或網頁
    const passThrough = (function(){
      const q = window.location.search || "";
      const h = window.location.hash || "";
      return (q + h);
    })();

    // 依平台組合最終 deeplink 與商店連結
    const schemeDeeplink = addParams(CONFIG.APP_SCHEME, passThrough);

    // 設定頁面可見之手動按鈕
    document.getElementById('iosStore').href = CONFIG.IOS_APP_STORE_URL;
    document.getElementById('androidStore').href = isAndroid ? CONFIG.ANDROID_PLAY_URL : CONFIG.ANDROID_PLAY_WEB_URL;
    document.getElementById('webFallback').href = CONFIG.WEB_FALLBACK_URL;

    // 立即開啟按鈕（提供使用者手勢，以提高成功率）
    document.getElementById('openApp').addEventListener('click', function(e){
      e.preventDefault();
      smartOpen(true);
    });

    // 進站即嘗試開啟 App（某些瀏覽器可能需要使用者手勢，上方按鈕可補救）
    setTimeout(() => smartOpen(false), 250);

    function smartOpen(fromUserGesture){
      if (!CONFIG.APP_SCHEME) {
        // 無 deep link 模式：直接導向各自商店或網頁
        if (isIOS) return safeNavigate(CONFIG.IOS_APP_STORE_URL);
        if (isAndroid) return safeNavigate(CONFIG.ANDROID_PLAY_URL);
        return safeNavigate(CONFIG.WEB_FALLBACK_URL);
      }

      if (isIOS) {
        tryOpeniOS(schemeDeeplink, CONFIG.IOS_APP_STORE_URL);
      } else if (isAndroid) {
        tryOpenAndroid(schemeDeeplink, CONFIG.ANDROID_PLAY_URL, CONFIG.ANDROID_PLAY_WEB_URL);
      } else {
        safeNavigate(CONFIG.WEB_FALLBACK_URL);
      }
    } else if (isAndroid) {
        // 盡量使用 intent://，可指定 package 與 fallback
        tryOpenAndroid(schemeDeeplink, CONFIG.ANDROID_PLAY_URL, CONFIG.ANDROID_PLAY_WEB_URL);
      } else {
        safeNavigate(CONFIG.WEB_FALLBACK_URL);
      }
    }

    // === 工具函式 ===
    function addParams(url, suffix){
      if (!suffix) return url;
      const hasQuery = url.includes('?');
      if (suffix.startsWith('?') || suffix.startsWith('#')) return url + suffix;
      return url + (hasQuery ? '&' : '?') + suffix.replace(/^\?/, '');
    }

    function tryOpeniOS(deeplink, storeUrl){
      const start = Date.now();
      const timer = setTimeout(function(){
        if (Date.now() - start < CONFIG.OPEN_TIMEOUT_MS + 200) {
          safeNavigate(storeUrl);
        }
      }, CONFIG.OPEN_TIMEOUT_MS);

      window.location.href = deeplink;

      document.addEventListener('visibilitychange', function onVis(){
        if (document.hidden) {
          clearTimeout(timer);
          document.removeEventListener('visibilitychange', onVis);
        }
      });
    }

    function tryOpenAndroid(deeplink, marketUrl, marketWebUrl){
      const start = Date.now();
      const timer = setTimeout(function(){
        if (Date.now() - start < CONFIG.OPEN_TIMEOUT_MS + 200) {
          // 若 intent:// 失敗，直接去 Play（App 或網頁）
          safeNavigate(isAndroid ? marketUrl : marketWebUrl);
        }
      }, CONFIG.OPEN_TIMEOUT_MS);

      // 若你不確定 scheme 是否正確，仍可先嘗試；接著用 intent:// 提升成功率
      try {
        window.location.href = deeplink;
      } catch (_) {}

      // intent:// 寫法：指定 scheme 與 package，並提供瀏覽器 fallback
      // ※ 將 scheme 與 package 改為實際值
      const pkg = 'org.lds.ldssa';
      const scheme = CONFIG.APP_SCHEME.split(':')[0]; // 取出 myapp:// 的 myapp 當 scheme 名稱
      const intentUrl = `intent://open${encodeURI(passThrough)}#Intent;scheme=${encodeURIComponent(scheme)};package=${pkg};S.browser_fallback_url=${encodeURIComponent(marketWebUrl)};end`;
      safeNavigate(intentUrl);

      document.addEventListener('visibilitychange', function onVis(){
        if (document.hidden) {
          clearTimeout(timer);
          document.removeEventListener('visibilitychange', onVis);
        }
      });
    }

    function safeNavigate(url){
      try { window.location.replace(url); }
      catch(_) { window.location.href = url; }
    }
  </script>
</body>
</html>

<!-- =========================
     LIFF Wrapper (liff-wrapper.html)
     放在另一個檔案，專門在 LINE 內使用，目的：以使用者手勢開「外部瀏覽器」→ 再由 smart link 偵測 iOS/Android。
     ========================= -->
<!--
使用方式：
1) 將下面檔案另存為 liff-wrapper.html，部署到你的 LIFF 網址。
2) 把 LIFF_ID、SMART_LINK_URL 改成你的實際值。
3) 在 LINE OA 裡用 LIFF 打開此頁，按「在外部瀏覽器開啟」，即可跳到 Smart App Link 頁面。
4) 此頁會附帶使用者的 displayName / userId（若權限允許）做為查詢參數，Smart App Link 會原樣轉交給 App。
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIFF → 外部瀏覽器啟動 App</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto; margin:0; padding:24px;}
    .box{max-width:680px;margin:0 auto;border:1px solid #e5e7eb;border-radius:16px;padding:20px}
    .btn{display:inline-block;padding:12px 16px;border:1px solid #cbd5e1;border-radius:12px;text-decoration:none}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="box">
    <h1>開啟外部瀏覽器以啟動 App</h1>
    <p>若未自動跳轉，請點下方按鈕。</p>
    <p><a id="openBtn" class="btn" href="#">在外部瀏覽器開啟</a></p>
    <p id="status" style="color:#64748b"></p>
  </div>
<script>
  const LIFF_ID = "2008163833-gJylL8BQ"; // ← 改成你的 LIFF ID
  const SMART_LINK_URL = "https://weichun0203.github.io/GospelLibrary/"; // ← 指向上一份 Smart App Link 頁面（已部署網址）

  async function init(){
    document.getElementById('status').textContent = '初始化中…';
    await liff.init({ liffId: LIFF_ID });
    await liff.ready;

    // 收集基本資料（可選）：以查詢參數帶到 Smart Link
    let params = new URLSearchParams();
    try{
      const os = liff.getOS();
      params.set('os', os);
      if (!liff.isLoggedIn()) await liff.login();
      const profile = await liff.getProfile();
      if (profile?.displayName) params.set('displayName', profile.displayName);
      if (liff.getContext()?.userId) params.set('userId', liff.getContext().userId);
    }catch(e){ /* 權限不足時忽略 */ }

    const url = SMART_LINK_URL + (SMART_LINK_URL.includes('?') ? '&' : '?') + params.toString();

    // 以外部瀏覽器開啟（關鍵）：避免 LIFF 內無法喚起外部 App
    const open = () => liff.openWindow({ url, external: true });

    // 立即嘗試
    open();

    // 預備手動按鈕
    document.getElementById('openBtn').addEventListener('click', (e)=>{ e.preventDefault(); open(); });

    document.getElementById('status').textContent = '若未自動開啟，請按「在外部瀏覽器開啟」。';
  }

  init();
</script>
</body>
</html>
